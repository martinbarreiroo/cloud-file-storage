@startuml Authentication Flow

' Define styles
skinparam componentStyle rectangle
skinparam defaultTextAlignment center

' Colors
!define APICOLOR #85BBF0
!define DBCOLOR #6C8EBF
!define USERCOLOR #E1D5E7

skinparam rectangle {
  BackgroundColor<<API>> APICOLOR
  BorderColor<<API>> #5D82A8
  BackgroundColor<<DB>> DBCOLOR
  BorderColor<<DB>> #5D6C7B
  BackgroundColor<<USER>> USERCOLOR
  BorderColor<<USER>> #9673A6
}

' Actors
actor "User" as user

' API Components
rectangle "NestJS API" <<API>> {
  rectangle "Auth Module" as auth_module {
    component "AuthController" as auth_controller
    component "AuthService" as auth_service
    component "JwtStrategy" as jwt_strategy
    component "LocalStrategy" as local_strategy
    component "JwtAuthGuard" as jwt_guard
  }
  
  rectangle "User Module" as user_module {
    component "UserController" as user_controller
    component "UserService" as user_service
    component "User Entity" as user_entity
  }
}

' Database
database "PostgreSQL" <<DB>> as db {
  component "users" as users_table
}

' Flow and relationships
user --> auth_controller : "1. Register/Login"
auth_controller --> auth_service : "2. Process Auth Request"
auth_service --> user_service : "3. Validate User"
user_service --> users_table : "4. Query User"
auth_service --> local_strategy : "5. Validate Credentials"
auth_service <-- jwt_strategy : "6. Generate JWT Token"
auth_service --> user : "7. Return JWT Token"

' Protected routes flow
user --> jwt_guard : "8. Access Protected Route\nwith JWT in Header"
jwt_guard --> jwt_strategy : "9. Validate Token"
jwt_strategy --> user_service : "10. Get User from Token"

' Relationships
user_service --> user_entity : "Uses"
user_entity --> users_table : "Persisted in"
auth_module --> user_module : "Depends on"

' Notes
note right of auth_service
  - Handles registration, login
  - Creates JWT with 1h expiration
  - Validates credentials
end note

note right of jwt_strategy
  - Extracts token from header
  - Validates JWT signature
  - Extracts user info from payload
end note

note right of local_strategy
  - Username/password validation
  - Used only during login
end note

note right of users_table
  - id
  - username
  - email
  - password (hashed)
  - role (user/admin)
  - createdAt
  - updatedAt
end note

@enduml